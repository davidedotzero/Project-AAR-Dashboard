# T8: ตรวจสอบและแก้ไขข้อผิดพลาดการสร้าง `_id` สำหรับ Task ใน Google Apps Script

## 1. ปัญหา (Problem Statement)

มีข้อสงสัยว่ากระบวนการสร้าง `_id` ที่ควรจะเป็น Unique ID สำหรับแต่ละ Task ในชีต 'Tasks' ผ่าน `API.gs` อาจทำงานผิดพลาดหรือไม่เสถียร ทำให้ Task ที่ถูกสร้างขึ้นใหม่บางรายการอาจไม่มี `_id` กำกับ

**ผลกระทบ:** หาก Task ไม่มี `_id` จะทำให้ฟังก์ชันที่ต้องอ้างอิงถึง Task นั้นๆ เช่น `updateTask`, `getTaskHistory` หรือการเชื่อมโยงข้อมูลในฝั่ง Frontend ทำงานผิดพลาด และส่งผลต่อความถูกต้องของข้อมูล (Data Integrity)

**ไฟล์ที่เกี่ยวข้อง:** `gas/API.js`

## 2. เป้าหมาย (Goal)

1.  **ระบุสาเหตุที่แท้จริง (Root Cause Analysis):** ค้นหาสาเหตุที่ทำให้ `_id` ไม่ถูกสร้างหรือบันทึกลงในชีต 'Tasks' อย่างสม่ำเสมอ
2.  **เสนอและดำเนินการแก้ไข:** พัฒนาแนวทางการแก้ไขที่มั่นใจได้ว่าทุก Task ที่สร้างขึ้นใหม่จะได้รับ `_id` ที่ไม่ซ้ำกันเสมอ
3.  **วางแผนแก้ไขข้อมูลเก่า (Data Remediation):** (ถ้าจำเป็น) เตรียมแนวทางสำหรับจัดการกับ Task เดิมที่ยังไม่มี `_id`

## 3. ขั้นตอนการตรวจสอบและวิเคราะห์ (Investigation & Analysis Steps)

1.  **ตรวจสอบโครงสร้าง Google Sheets:**
    * เปิด Spreadsheet และไปที่ชีต `Tasks`.
    * ยืนยันว่ามีคอลัมน์ที่ชื่อ `_id` อยู่จริง และชื่อตรงกับค่าในตัวแปร `const TASK_ID_COLUMN_NAME = '_id';` แบบตรงตัว (case-sensitive).

2.  **วิเคราะห์ฟังก์ชัน `createTask_API`:**
    * ตรวจสอบ Logic ในฟังก์ชัน `createTask_API` อย่างละเอียด
    * **จุดที่ต้องให้ความสำคัญ:** `if (headers.includes(TASK_ID_COLUMN_NAME)) { ... }`
    * **สมมติฐาน:** หาก `headers` ที่ดึงมาจากชีตไม่มีค่า `_id` (อาจเกิดจากชื่อคอลัมน์ผิดหรือปัญหาอื่นๆ) Task จะถูกสร้างขึ้นโดยไม่มี `_id` แต่ **Script จะไม่แจ้งข้อผิดพลาด** (Silent Failure)

3.  **วิเคราะห์ฟังก์ชัน `createNewProject_API`:**
    * ตรวจสอบ Logic การสร้าง Task ภายในฟังก์ชันนี้ ซึ่งมีลักษณะคล้ายกับ `createTask_API` และอาจมีปัญหาเดียวกัน

4.  **ตรวจสอบ Logs:**
    * ไปที่ Apps Script Editor > Executions เพื่อตรวจสอบว่ามี Error ที่เกี่ยวข้องกับการอ่าน `headers` หรือการเขียนข้อมูลลงชีตหรือไม่

5.  **ทดสอบเพื่อจำลองปัญหา (Reproduce):**
    * เรียกใช้ `createTask` API ผ่าน Postman หรือจาก Frontend โดยตรง
    * สังเกตการณ์ที่ชีต 'Tasks' ว่าแถวใหม่ที่ถูกสร้างขึ้นมีค่าในคอลัมน์ `_id` หรือไม่
    * ทดลองเปลี่ยนชื่อคอลัมน์ `_id` ในชีตเป็นชื่ออื่นชั่วคราว แล้วลองสร้าง Task ใหม่เพื่อดูว่าเกิดปัญหา Silent Failure จริงหรือไม่

## 4. แนวทางการแก้ไขที่คาดการณ์ (Proposed Solution)

1.  **ทำให้โค้ดมีความทนทานสูงขึ้น (Code Hardening):**
    * ปรับปรุง Logic ใน `createTask_API` และ `createNewProject_API` ให้มีการตรวจสอบว่าพบ `_id` ใน `headers` หรือไม่ หากไม่พบ **ให้ `throw new Error()` ทันที** เพื่อป้องกันการสร้างข้อมูลที่ไม่สมบูรณ์
    * **ตัวอย่าง:**
        ```javascript
        const headers = tasksSheet.getRange(1, 1, 1, tasksSheet.getLastColumn()).getValues()[0];
        if (!headers.includes(TASK_ID_COLUMN_NAME)) {
          throw new Error("Critical Configuration Error: '_id' column is missing in 'Tasks' sheet.");
        }
        
        // ... a-z ... a-z ... 
        
        let newId = Utilities.getUuid();
        newRowData[TASK_ID_COLUMN_NAME] = newId; 
        // ไม่ต้องมี if check ซ้ำซ้อน เพราะเราตรวจสอบไปตั้งแต่ต้นแล้ว
        ```

2.  **สร้าง Script สำหรับแก้ไขข้อมูลเก่า (Backfill Script):**
    * (ถ้าจำเป็น) เขียนฟังก์ชันพิเศษใน Apps Script ที่ทำงานครั้งเดียว (one-time script) เพื่อวนลูปตรวจสอบทุกแถวในชีต 'Tasks'
    * หากแถวใดไม่มีค่าในคอลัมน์ `_id` ให้ใช้ `Utilities.getUuid()` สร้าง ID ใหม่และเติมลงไป

## 5. เกณฑ์การยอมรับ (Acceptance Criteria)

- [ ] สามารถระบุและสรุปสาเหตุของปัญหาได้อย่างชัดเจน
- [ ] โค้ดใน `API.gs` ได้รับการแก้ไขให้สามารถป้องกันการสร้าง Task ที่ไม่มี `_id` ได้
- [ ] เมื่อเรียกใช้ `createTask_API` เพื่อสร้าง Task ใหม่, คอลัมน์ `_id` ในแถวที่สร้างใหม่จะต้องมีค่า UUID ที่ไม่ซ้ำกันเสมอ
- [ ] เมื่อเรียกใช้ `createNewProject_API` พร้อมกับ Task, Task ใหม่ทุกตัวที่ถูกสร้างจะต้องมี `_id` ที่ไม่ซ้ำกัน
- [ ] (ถ้ามี) Task เก่าที่ไม่มี `_id` ได้รับการแก้ไขให้มีข้อมูลครบถ้วน
- [ ] สามารถนำไฟล์ออกไปใช้งานได้ใน App Script 